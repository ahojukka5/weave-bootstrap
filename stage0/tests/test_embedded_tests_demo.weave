(program
  (name "embedded-tests-demo")
  (doc "Demo program with embedded tests in function.")
  (version "0.1")

  (type ExitCode
    (alias Int32)
  ) ;; type ExitCode

  (fn add2
    (doc "Returns n + 2.")
    (params (n Int32))
    (returns Int32)
    (body
      (+ n 2)
    ) ;; body
    (tests
      (test add2-forty-is-forty-two
        (doc "add2(40) should be 42")
        (tags unit arithmetic)
        (body
          (let result Int32 (add2 40))
          (expect-true (< result 100)
            (debug
              (ccall "printf" (returns Int32)
                (args (String "result=%d should be < 100\0A") (Int32 result)))))
          (expect-eq result 42)
        )
      )
      (test add2-zero-is-two
        (doc "add2(0) should be 2")
        (tags unit)
        (body
          (let result Int32 (add2 0))
          (expect-eq result 2)
        )
      )
    ) ;; tests
  ) ;; fn add2

  (entry main
    (doc "Return 42 via add2.")
    (params ())
    (returns ExitCode)
    (body
      (return (add2 40))
    ) ;; body
  ) ;; entry main
) ;; program
