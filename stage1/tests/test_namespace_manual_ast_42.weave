(program
  (name "test-namespace-manual-ast-42")
  (version "0.1")

  (include "../src/string.weave")
  (include "../src/buffers.weave")
  (include "../src/arrays.weave")
  (include "../src/arena.weave")
  (include "../src/ir/util.weave")

  (entry main
    (params ())
    (returns Int32)
    (body
      (do
        ;; Manually construct AST: (module (namespace "io" (fn test-fn (params ()) (returns String) (body "hello"))))
        (let a (ptr Arena) (arena-create 4096))
        
        ;; Create module node
        (let module-node Int32 (arena-add-node a (node-kind-list) ""))
        (let module-head Int32 (arena-add-node a (node-kind-atom) "module"))
        (arena-set-first-child a module-node module-head)
        
        ;; Create namespace block: (namespace "io" ...)
        (let ns-block Int32 (arena-add-node a (node-kind-list) ""))
        (let ns-head Int32 (arena-add-node a (node-kind-atom) "namespace"))
        (let ns-name Int32 (arena-add-node a (node-kind-atom) "io"))
        (arena-set-first-child a ns-block ns-head)
        (arena-set-next-sibling a ns-head ns-name)
        
        ;; Create function: (fn test-fn (params ()) (returns String) (body "hello"))
        (let fn-block Int32 (arena-add-node a (node-kind-list) ""))
        (let fn-head Int32 (arena-add-node a (node-kind-atom) "fn"))
        (let fn-name Int32 (arena-add-node a (node-kind-atom) "test-fn"))
        (let params-block Int32 (arena-add-node a (node-kind-list) ""))
        (let params-head Int32 (arena-add-node a (node-kind-atom) "params"))
        (let params-empty Int32 (arena-add-node a (node-kind-list) ""))
        (let returns-block Int32 (arena-add-node a (node-kind-list) ""))
        (let returns-head Int32 (arena-add-node a (node-kind-atom) "returns"))
        (let returns-type Int32 (arena-add-node a (node-kind-atom) "String"))
        
        (arena-set-first-child a fn-block fn-head)
        (arena-set-next-sibling a fn-head fn-name)
        (arena-set-next-sibling a fn-name params-block)
        (arena-set-first-child a params-block params-head)
        (arena-set-next-sibling a params-head params-empty)
        (arena-set-next-sibling a params-block returns-block)
        (arena-set-first-child a returns-block returns-head)
        (arena-set-next-sibling a returns-head returns-type)
        
        ;; Link function to namespace
        (arena-set-next-sibling a ns-name fn-block)
        
        ;; Link namespace to module
        (arena-set-next-sibling a module-head ns-block)
        
        ;; Now test collection
        (let names ArrayString (array-string-create))
        (let types ArrayInt32 (array-int32-create))
        (ir::collect-fn-sigs-from-module a module-node names types "")
        
        ;; Should find 2 entries (qualified and unqualified)
        (if-stmt (!= (array-str-len names) 2)
          (return 1) ;; Wrong number of entries
          (do 0)
        )
        
        ;; Check that test-fn is found
        (let found-fn Int32 0)
        (let i Int32 0)
        (while (< i (array-str-len names))
          (do
            (let name String (array-str-get names i))
            (if-stmt (|| (string-eq name "test-fn") (string-eq name "io::test-fn"))
              (set found-fn 1)
              (do 0)
            )
            (set i (+ i 1))
          )
        )
        (if-stmt (!= found-fn 1)
          (return 2) ;; Function not found
          (return 42) ;; Success!
        )
      )
    )
  )
)

