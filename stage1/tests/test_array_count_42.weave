(program
  (name "test-array-count-42")
  (doc "Count occurrences of value in array.")
  (version "0.1")

  (type ExitCode
    (alias Int32)
  )

  (fn array-count
    (doc "Count how many times target appears in array.")
    (params (arr (ptr Int32)) (len Int32) (target Int32))
    (returns Int32)
    (body
      (do
        (let count Int32 0)
        (let i Int32 0)
        (while (< i len)
          (do
            (if-stmt (== (load Int32 (ptr-add Int32 arr i)) target)
              (set count (+ count 1))
              (do 0)
            )
            (set i (+ i 1))
          )
        )
        (return count)
      )
    )
  )

  (entry main
    (doc "Count 7s in array [7,3,7,7,5,7,2,7,7], multiply by 7.")
    (params ())
    (returns ExitCode)
    (body
      (do
        (let arr-raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 36))))
        (let arr (ptr Int32) (bitcast (ptr Int32) arr-raw))
        (store Int32 7 (ptr-add Int32 arr 0))
        (store Int32 3 (ptr-add Int32 arr 1))
        (store Int32 7 (ptr-add Int32 arr 2))
        (store Int32 7 (ptr-add Int32 arr 3))
        (store Int32 5 (ptr-add Int32 arr 4))
        (store Int32 7 (ptr-add Int32 arr 5))
        (store Int32 2 (ptr-add Int32 arr 6))
        (store Int32 7 (ptr-add Int32 arr 7))
        (store Int32 7 (ptr-add Int32 arr 8))
        
        (let count Int32 (array-count arr 9 7))
        ;; count = 6, 6 * 7 = 42
        (return (* count 7))
      )
    )
  )
)
