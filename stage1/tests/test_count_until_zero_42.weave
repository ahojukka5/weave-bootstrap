(program
  (name "test-count-until-zero-42")
  (doc "Count non-zero elements in array until hitting zero.")
  (version "0.1")

  (type ExitCode
    (alias Int32)
  )

  (fn count-until-zero
    (doc "Count elements until hitting zero.")
    (params (arr (ptr Int32)))
    (returns Int32)
    (body
      (do
        (let count Int32 0)
        (let done Int32 0)
        (while (== done 0)
          (do
            (let val Int32 (load Int32 (ptr-add Int32 arr count)))
            (if-stmt (== val 0)
              (set done 1)
              (set count (+ count 1))
            )
          )
        )
        (return count)
      )
    )
  )

  (entry main
    (doc "Count elements before zero marker.")
    (params ())
    (returns ExitCode)
    (body
      (do
        ;; Array: [1,2,3,4,5,6,7,8,9,10,11,12,13,0]
        (let arr-raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 56))))
        (let arr (ptr Int32) (bitcast (ptr Int32) arr-raw))
        (store Int32 1 (ptr-add Int32 arr 0))
        (store Int32 2 (ptr-add Int32 arr 1))
        (store Int32 3 (ptr-add Int32 arr 2))
        (store Int32 4 (ptr-add Int32 arr 3))
        (store Int32 5 (ptr-add Int32 arr 4))
        (store Int32 6 (ptr-add Int32 arr 5))
        (store Int32 7 (ptr-add Int32 arr 6))
        (store Int32 8 (ptr-add Int32 arr 7))
        (store Int32 9 (ptr-add Int32 arr 8))
        (store Int32 10 (ptr-add Int32 arr 9))
        (store Int32 11 (ptr-add Int32 arr 10))
        (store Int32 12 (ptr-add Int32 arr 11))
        (store Int32 13 (ptr-add Int32 arr 12))
        (store Int32 0 (ptr-add Int32 arr 13))
        
        (let len Int32 (count-until-zero arr))
        ;; len = 13, 13 * 3 + 3 = 42
        (return (+ (* len 3) 3))
      )
    )
  )
)
