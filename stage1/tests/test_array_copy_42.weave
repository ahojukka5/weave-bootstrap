(program
  (name "test-array-copy-42")
  (doc "Copy array elements from one array to another.")
  (version "0.1")

  (type ExitCode
    (alias Int32)
  )

  (fn array-copy
    (doc "Copy len elements from src to dest.")
    (params (dest (ptr Int32)) (src (ptr Int32)) (len Int32))
    (returns Int32)
    (body
      (do
        (let i Int32 0)
        (while (< i len)
          (do
            (let src-ptr (ptr Int32) (ptr-add Int32 src i))
            (let dest-ptr (ptr Int32) (ptr-add Int32 dest i))
            (store Int32 (load Int32 src-ptr) dest-ptr)
            (set i (+ i 1))
          )
        )
        (return 0)
      )
    )
  )

  (entry main
    (doc "Copy array [10, 20, 12] to dest, sum dest to get 42.")
    (params ())
    (returns ExitCode)
    (body
      (do
        (let src-raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 12))))
        (let src (ptr Int32) (bitcast (ptr Int32) src-raw))
        (let dest-raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 12))))
        (let dest (ptr Int32) (bitcast (ptr Int32) dest-raw))
        (store Int32 10 (ptr-add Int32 src 0))
        (store Int32 20 (ptr-add Int32 src 1))
        (store Int32 12 (ptr-add Int32 src 2))
        (array-copy dest src 3)
        (let sum Int32 0)
        (set sum (+ sum (load Int32 (ptr-add Int32 dest 0))))
        (set sum (+ sum (load Int32 (ptr-add Int32 dest 1))))
        (set sum (+ sum (load Int32 (ptr-add Int32 dest 2))))
        (return sum)
      )
    )
  )
)
