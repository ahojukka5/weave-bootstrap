(program
  (name "test-namespace-collection-42")
  (version "0.1")

  (include "../src/string.weave")
  (include "../src/buffers.weave")
  (include "../src/arrays.weave")
  (include "../src/arena.weave")
  (include "../src/sexpr_parser.weave")
  (include "../src/ir/util.weave")

  (entry main
    (params ())
    (returns Int32)
    (body
      (do
        ;; Test 1: Empty module
        (let a1 (ptr Arena) (arena-create 4096))
        (let root1 Int32 (parser::parse-string a1 "(module (name \"test\"))"))
        (let names1 ArrayString (array-string-create))
        (let types1 ArrayInt32 (array-int32-create))
        (ir::collect-fn-sigs-from-module a1 root1 names1 types1 "")
        (if-stmt (!= (array-str-len names1) 0) (return 1) (do 0))

        ;; Test 2: Module with namespace block containing one function
        (let a2 (ptr Arena) (arena-create 4096))
        (let root2 Int32 (parser::parse-string a2 "(module (name \"test\") (namespace \"io\" (fn test-fn (params ()) (returns String) (body \"hello\"))))"))
        (let names2 ArrayString (array-string-create))
        (let types2 ArrayInt32 (array-int32-create))
        (ir::collect-fn-sigs-from-module a2 root2 names2 types2 "")
        (if-stmt (!= (array-str-len names2) 2) (return 2) (do 0))
        ;; Check that both qualified and unqualified names are present
        (let found-qualified Int32 0)
        (let found-unqualified Int32 0)
        (let i Int32 0)
        (while (< i (array-str-len names2))
          (do
            (let name String (array-str-get names2 i))
            (if-stmt (string-eq name "io::test-fn")
              (set found-qualified 1)
              (do 0)
            )
            (if-stmt (string-eq name "test-fn")
              (set found-unqualified 1)
              (do 0)
            )
            (set i (+ i 1))
          )
        )
        (if-stmt (!= found-qualified 1) (return 3) (do 0))
        (if-stmt (!= found-unqualified 1) (return 4) (do 0))

        ;; Test 3: Module with namespace block containing multiple functions
        (let a3 (ptr Arena) (arena-create 4096))
        (let root3 Int32 (parser::parse-string a3 "(module (name \"test\") (namespace \"io\" (fn fn1 (params ()) (returns Int32) (body 0)) (fn fn2 (params ()) (returns String) (body \"\"))))"))
        (let names3 ArrayString (array-string-create))
        (let types3 ArrayInt32 (array-int32-create))
        (ir::collect-fn-sigs-from-module a3 root3 names3 types3 "")
        (if-stmt (!= (array-str-len names3) 4) (return 5) (do 0))
        ;; Check that both functions are found
        (let found-fn1 Int32 0)
        (let found-fn2 Int32 0)
        (set i 0)
        (while (< i (array-str-len names3))
          (do
            (let name String (array-str-get names3 i))
            (if-stmt (|| (string-eq name "fn1") (string-eq name "io::fn1"))
              (set found-fn1 1)
              (do 0)
            )
            (if-stmt (|| (string-eq name "fn2") (string-eq name "io::fn2"))
              (set found-fn2 1)
              (do 0)
            )
            (set i (+ i 1))
          )
        )
        (if-stmt (!= found-fn1 1) (return 6) (do 0))
        (if-stmt (!= found-fn2 1) (return 7) (do 0))

        ;; All tests passed
        42
      )
    )
  )
)

