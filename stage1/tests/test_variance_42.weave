(program
  (name "test-variance-42")
  (doc "Calculate variance of array elements.")
  (version "0.1")

  (type ExitCode
    (alias Int32)
  )

  (fn mean
    (doc "Calculate mean of array.")
    (params (arr (ptr Int32)) (len Int32))
    (returns Int32)
    (body
      (do
        (let sum Int32 0)
        (let i Int32 0)
        (while (< i len)
          (do
            (set sum (+ sum (load Int32 (ptr-add Int32 arr i))))
            (set i (+ i 1))
          )
        )
        (return (/ sum len))
      )
    )
  )

  (fn variance
    (doc "Calculate variance: sum((x - mean)^2) / n.")
    (params (arr (ptr Int32)) (len Int32))
    (returns Int32)
    (body
      (do
        (let avg Int32 (mean arr len))
        (let sum-sq Int32 0)
        (let i Int32 0)
        (while (< i len)
          (do
            (let val Int32 (load Int32 (ptr-add Int32 arr i)))
            (let diff Int32 (- val avg))
            (let sq Int32 (* diff diff))
            (set sum-sq (+ sum-sq sq))
            (set i (+ i 1))
          )
        )
        (return (/ sum-sq len))
      )
    )
  )

  (entry main
    (doc "Variance of [10,20,30,40,50] = 200, divide by 5, add 2.")
    (params ())
    (returns ExitCode)
    (body
      (do
        (let arr-raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 20))))
        (let arr (ptr Int32) (bitcast (ptr Int32) arr-raw))
        (store Int32 10 (ptr-add Int32 arr 0))
        (store Int32 20 (ptr-add Int32 arr 1))
        (store Int32 30 (ptr-add Int32 arr 2))
        (store Int32 40 (ptr-add Int32 arr 3))
        (store Int32 50 (ptr-add Int32 arr 4))
        
        (let var Int32 (variance arr 5))
        ;; mean = 30, variance = ((20^2 + 10^2 + 0 + 10^2 + 20^2) / 5) = 200
        ;; 200 / 5 + 2 = 42
        (return (+ (/ var 5) 2))
      )
    )
  )
)
