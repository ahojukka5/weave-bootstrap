(program
  (name "test-ccall-malloc-42")
  (doc "Allocate with malloc, store two ints, sum to 42, free memory.")

  (entry main
    (doc "Malloc 8 bytes, write 40 and 2, free, return 42.")
    (params)
    (returns Int32)
    (body
      (do
        (let raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 8))))
        (let p (ptr Int32) (bitcast (ptr Int32) raw))
        (store Int32 40 p)
        (store Int32 2 (ptr-add Int32 p 1))
        (let a Int32 (load Int32 p))
        (let b Int32 (load Int32 (ptr-add Int32 p 1)))
        (ccall "free" (returns Void) (args ((ptr Int8) raw)))
        (return (+ a b))
      ) ;; do
    ) ;; body
  ) ;; entry
) ;; program
