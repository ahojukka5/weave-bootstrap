(program
  (name "test-binary-search-42")
  (doc "Binary search in a sorted array.")
  (version "0.1")

  (type ExitCode
    (alias Int32)
  )

  (fn binary-search
    (doc "Search for target in sorted array, return index or -1.")
    (params (arr (ptr Int32)) (size Int32) (target Int32))
    (returns Int32)
    (body
      (do
        (let left Int32 0)
        (let right Int32 (- size 1))
        (let result Int32 (- 0 1))
        (while (<= left right)
          (do
            (let mid Int32 (/ (+ left right) 2))
            (let mid-ptr (ptr Int32) (ptr-add Int32 arr mid))
            (let mid-val Int32 (load Int32 mid-ptr))
            (if-stmt (== mid-val target)
              (do
                (set result mid)
                (set left (+ right 1))
              )
              (if-stmt (< mid-val target)
                (set left (+ mid 1))
                (set right (- mid 1))
              )
            )
          )
        )
        (return result)
      )
    )
  )

  (entry main
    (doc "Binary search for 42 in sorted array.")
    (params ())
    (returns ExitCode)
    (body
      (do
        (let size Int32 7)
        (let bytes Int32 (* size 4))
        (let arr-raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 bytes))))
        (let arr-ptr (ptr Int32) (bitcast (ptr Int32) arr-raw))
        
        ;; Initialize sorted array: [10, 20, 30, 42, 50, 60, 70]
        (store Int32 10 (ptr-add Int32 arr-ptr 0))
        (store Int32 20 (ptr-add Int32 arr-ptr 1))
        (store Int32 30 (ptr-add Int32 arr-ptr 2))
        (store Int32 42 (ptr-add Int32 arr-ptr 3))
        (store Int32 50 (ptr-add Int32 arr-ptr 4))
        (store Int32 60 (ptr-add Int32 arr-ptr 5))
        (store Int32 70 (ptr-add Int32 arr-ptr 6))
        
        (let index Int32 (binary-search arr-ptr size 42))
        ;; index = 3, need to return 42
        ;; We'll get the value at found index
        (let found-ptr (ptr Int32) (ptr-add Int32 arr-ptr index))
        (return (load Int32 found-ptr))
      )
    )
  )
)
