(program
  (name "test-array-max-42")
  (doc "Find maximum element in an array.")
  (version "0.1")

  (type ExitCode
    (alias Int32)
  )

  (fn array-max
    (doc "Find maximum value in array.")
    (params (arr (ptr Int32)) (size Int32))
    (returns Int32)
    (body
      (do
        (let max-val Int32 (load Int32 (ptr-add Int32 arr 0)))
        (let i Int32 1)
        (while (< i size)
          (do
            (let curr-ptr (ptr Int32) (ptr-add Int32 arr i))
            (let curr-val Int32 (load Int32 curr-ptr))
            (if-stmt (> curr-val max-val)
              (set max-val curr-val)
              (do 0)
            )
            (set i (+ i 1))
          )
        )
        (return max-val)
      )
    )
  )

  (entry main
    (doc "Find max in array [15, 42, 8, 30, 25].")
    (params ())
    (returns ExitCode)
    (body
      (do
        (let size Int32 5)
        (let bytes Int32 (* size 4))
        (let arr-raw (ptr Int8) (ccall "malloc" (returns (ptr Int8)) (args (Int32 bytes))))
        (let arr-ptr (ptr Int32) (bitcast (ptr Int32) arr-raw))
        
        (store Int32 15 (ptr-add Int32 arr-ptr 0))
        (store Int32 42 (ptr-add Int32 arr-ptr 1))
        (store Int32 8 (ptr-add Int32 arr-ptr 2))
        (store Int32 30 (ptr-add Int32 arr-ptr 3))
        (store Int32 25 (ptr-add Int32 arr-ptr 4))
        
        (return (array-max arr-ptr size))
      )
    )
  )
)
